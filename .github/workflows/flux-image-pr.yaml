name: Create PR from Flux Image Updates

on:
  # Run on schedule to catch any flux branches without PRs
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  # Also run on push for immediate PR creation (when workflow is on the branch)
  push:
    branches:
      - 'flux/**'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  create-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create PRs for Flux branches
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Get all remote flux branches
          git fetch origin

          for branch in $(git branch -r | grep 'origin/flux/' | sed 's|origin/||'); do
            echo "Checking branch: $branch"

            # Check if PR already exists for this branch
            existing_pr=$(gh pr list --head "$branch" --json number --jq '.[0].number')

            if [ -n "$existing_pr" ]; then
              echo "  PR #$existing_pr already exists"
            else
              echo "  Creating PR for $branch"
              gh pr create \
                --title "ðŸ¤– Flux: Image update" \
                --body "Automated image update by Flux Image Automation.

          This PR was automatically created when Flux detected a new container image.

          ---
          _Merge this PR to deploy the new image version._" \
                --base main \
                --head "$branch" \
                --label "flux" \
                --label "image-update" \
                --label "automation" || echo "  Failed to create PR (may already exist or no diff)"
            fi
          done
